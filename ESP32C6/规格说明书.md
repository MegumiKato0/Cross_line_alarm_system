# XIAO ESP32-C6 越线报警系统规格说明书

## 1. 系统概述

### 1.1 产品名称
**ADC检测广播系统 v3.6 (自动恢复版)**

### 1.2 产品描述
基于XIAO ESP32-C6微控制器的智能ADC检测广播系统，通过D0引脚ADC输入检测模拟信号变化，当信号超过设定阈值时自动触发报警并通过UDP广播发送报警信息。系统具备低功耗模式、AP热点备用、智能重试机制和可靠的报警队列管理。

### 1.3 应用场景
- 模拟信号监测系统
- 工业传感器数据采集
- 环境监测报警系统
- 智能家居传感器网络
- 24小时无人值守监控
- 分布式传感器网络

### 1.4 核心特性
- ✅ ADC模拟信号检测与自动恢复
- ✅ UDP广播通信协议
- ✅ WiFi断线自动切换AP热点模式
- ✅ 低功耗睡眠模式与ADC唤醒
- ✅ 报警队列与断电恢复
- ✅ 智能重试机制
- ✅ 多模式LED状态指示

## 2. 技术规格

### 2.1 硬件规格

| 项目 | 规格 |
|------|------|
| 主控芯片 | ESP32-C6 |
| 开发板 | XIAO ESP32-C6 |
| 工作电压 | 3.3V/5V |
| 工作电流 | 约150mA（WiFi工作时），<10mA（睡眠模式） |
| 工作温度 | -40°C ~ +85°C |
| 尺寸 | 21×17.5mm（主板） |
| 续航能力 | 24小时持续运行 |
| ADC精度 | 12位（0-4095） |
| ADC输入电压 | 0-3.3V |

### 2.2 接口定义

| 引脚 | 功能 | 连接设备 | 说明 |
|------|------|----------|------|
| D0 | ADC输入 | 模拟传感器信号 | 12位ADC，0-3.3V输入 |
| D3 | 数字输入 | 重置按钮 | 上拉输入，低电平触发 |
| D4 | 数字输出 | 3.3V电压输出控制 | 报警时输出高电平5秒 |
| LED_BUILTIN | 数字输出 | 状态指示LED | 多模式状态指示 |

### 2.3 通信规格

| 项目 | 规格 |
|------|------|
| WiFi标准 | 802.11 b/g/n |
| 频率范围 | 2.4GHz |
| 通信协议 | UDP广播 |
| 数据格式 | 自定义二进制协议帧 |
| 网络模式 | Station模式 + AP热点备用 |
| 广播端口 | 5439 |
| 帧长度 | 6字节 |
| 重连机制 | 智能重连，指数退避算法 |

### 2.4 AP热点模式

| 项目 | 配置 |
|------|------|
| 热点名称 | ADC_Alarm_Device |
| 热点密码 | 12345678 |
| AP IP地址 | 192.168.4.1 |
| 子网掩码 | 255.255.255.0 |
| 广播地址 | 192.168.4.255 |

## 3. 通信协议

### 3.1 UDP广播协议帧格式

| 字节位置 | 字段名称 | 长度 | 数值 | 描述 |
|----------|----------|------|------|------|
| 0 | 帧头 | 1字节 | 0xAA | 固定帧头标识 |
| 1 | 指令类型 | 1字节 | 0x00-0x03 | 见指令定义表 |
| 2 | 设备ID | 1字节 | 0x01-0xFE | 设备唯一标识 |
| 3 | 状态字段 | 1字节 | 0x00-0x02 | 见状态定义表 |
| 4 | WiFi状态 | 1字节 | 0-255 | RSSI值或WiFi状态 |
| 5 | 帧尾 | 1字节 | 0x55 | 固定帧尾标识 |

### 3.2 指令定义

| 指令代码 | 指令名称 | 描述 |
|----------|----------|------|
| 0x00 | CMD_ONLINE | 设备上线通知 |
| 0x01 | CMD_ALARM | 报警触发 |
| 0x02 | CMD_RECOVER | 报警恢复 |
| 0x03 | CMD_HEARTBEAT | 心跳包 |

### 3.3 状态定义

| 状态代码 | 状态名称 | 描述 |
|----------|----------|------|
| 0x00 | STATUS_NORMAL | 正常状态 |
| 0x01 | STATUS_ALARM | 报警状态 |
| 0x02 | STATUS_RECOVER | 恢复状态 |

### 3.4 协议帧示例

```
上线广播: AA 00 01 00 2D 55
报警广播: AA 01 01 01 2D 55
恢复广播: AA 02 01 02 2D 55
心跳包:   AA 03 01 00 2D 55
```

## 4. 功能特性

### 4.1 ADC检测功能
- **触发阈值**: 1000 (可配置，0-4095范围)
- **恢复阈值**: 900 (触发阈值-100)
- **采样频率**: 每100ms采样一次
- **自动恢复**: 信号低于恢复阈值时自动发送恢复广播
- **防抖动**: 避免在阈值附近频繁触发

### 4.2 网络通信功能
- **主模式**: 连接指定WiFi网络进行UDP广播
- **备用模式**: WiFi连接失败时自动启动AP热点
- **强制广播**: 确保在任何网络状态下都能发送数据
- **智能重连**: 断线后自动重连，支持快速重连和长时间重连

### 4.3 低功耗管理
- **自动睡眠**: 闲置5分钟后进入深度睡眠
- **ADC唤醒**: ADC信号变化时立即唤醒
- **WiFi管理**: 睡眠时断开WiFi连接节省电力
- **唤醒处理**: 唤醒后自动重连WiFi并处理待发送报警

### 4.4 报警队列管理
- **队列容量**: 最多缓存10个报警记录
- **持久化存储**: 断电重启后自动恢复未发送报警
- **智能重试**: 指数退避算法，5秒→10秒→20秒→...→60秒
- **状态跟踪**: 记录每个报警的发送状态和重试次数

### 4.5 LED状态指示

| LED模式 | 闪烁模式 | 系统状态 |
|---------|----------|----------|
| 关闭 | 不亮 | 睡眠模式 |
| 慢速闪烁 | 1秒间隔 | WiFi未连接 |
| 快速闪烁 | 0.5秒间隔 | WiFi连接中/有报警待发送 |
| 双闪 | 快速双闪 | AP热点模式 |
| 常亮 | 持续亮起 | 正常工作状态 |

## 5. 配置参数

### 5.1 网络配置
```cpp
const char* ssid = "XMKKK";         // WiFi名称
const char* password = "05925050500"; // WiFi密码
const int broadcastPort = 5439;   // UDP广播端口
const char* broadcastIP = "255.255.255.255"; // 广播地址
```

### 5.2 时间参数
```cpp
const unsigned long debounceDelay = 50;        // 按钮去抖动延迟（毫秒）
const unsigned long wifiRetryInterval = 30000; // WiFi重连间隔（毫秒）
const unsigned long wifiQuickRetryInterval = 5000; // 快速重连间隔（毫秒）
const unsigned long heartbeatInterval = 60000; // 心跳包间隔（毫秒）
const unsigned long idleTimeBeforeSleep = 300000; // 闲置5分钟后睡眠
const unsigned long alarmRetryInterval = 5000; // 报警重试间隔（毫秒）
const unsigned long maxAlarmRetryInterval = 60000; // 最大重试间隔（毫秒）
const unsigned long adcWakeUpInterval = 2000; // ADC唤醒检查间隔（毫秒）
```

### 5.3 ADC配置
```cpp
const int adcThreshold = 1000;    // ADC触发阈值（0-4095）
const unsigned long adcSampleInterval = 100; // ADC采样间隔（毫秒）
const unsigned long voltageOutputDuration = 5000; // 3.3V输出持续时间（毫秒）
```

### 5.4 设备配置
```cpp
uint8_t deviceId = 1;  // 设备ID（1-254）
const int MAX_ALARM_QUEUE = 10; // 报警队列最大容量
const int maxWifiReconnectAttempts = 5; // 最大WiFi重连尝试次数
```

## 6. 工作模式

### 6.1 正常工作模式
- 实时监控ADC输入信号
- 定期发送心跳包（每60秒）
- 处理报警队列中的未发送报警
- 维护WiFi连接状态
- 响应重置按钮操作

### 6.2 低功耗睡眠模式
- 闲置5分钟后自动进入
- 断开WiFi连接节省电力
- 设置ADC引脚为唤醒源
- 每2秒检查一次ADC信号变化
- ADC触发后立即唤醒系统

### 6.3 AP热点模式
- WiFi连接失败时自动启动
- 创建名为"ADC_Alarm_Device"的热点
- 通过192.168.4.255地址进行广播
- 定期尝试连接原WiFi网络
- 支持其他设备连接接收广播

### 6.4 报警处理流程
1. **信号检测**: ADC值超过1000阈值
2. **触发响应**: 立即输出3.3V信号（持续5秒）
3. **队列管理**: 添加报警记录到队列
4. **网络检查**: 确保WiFi连接可用
5. **广播发送**: 发送报警广播帧
6. **重试机制**: 发送失败时自动重试
7. **恢复检测**: ADC值降至900以下时发送恢复广播

## 7. 安装与使用

### 7.1 硬件连接
1. 将模拟传感器信号线连接到D0引脚（ADC输入，0-3.3V）
2. 将外部设备控制线连接到D4引脚（3.3V输出控制）
3. 将重置按钮一端连接到D3引脚，另一端接地
4. 为系统提供5V或3.3V电源
5. 确保ADC输入信号在0-3.3V范围内

### 7.2 软件配置
1. 在Arduino IDE中安装XIAO ESP32-C6开发板支持
2. 修改WiFi配置参数（ssid和password）
3. 设置设备ID（多设备部署时使用不同ID）
4. 调整ADC阈值以适应传感器特性
5. 配置广播端口和IP地址
6. 编译并上传代码

### 7.3 系统启动流程
1. 系统上电自检
2. 初始化硬件引脚
3. 恢复存储的报警队列
4. 连接WiFi网络
5. 发送上线广播
6. 设置ADC唤醒源
7. 进入正常工作模式

### 7.4 网络部署
1. **单设备部署**: 直接连接现有WiFi网络
2. **多设备部署**: 为每个设备分配唯一ID
3. **离线部署**: 依赖AP热点模式进行通信
4. **混合部署**: 部分设备连接WiFi，部分使用AP模式

## 8. 监控与调试

### 8.1 串口调试信息
- 串口波特率：115200
- 详细的系统状态输出
- ADC值实时监控
- WiFi连接状态跟踪
- 报警队列状态显示
- 广播帧十六进制输出

### 8.2 LED状态监控
- 通过板载LED观察系统状态
- 不同闪烁模式表示不同状态
- 便于现场快速故障判断
- 支持远程状态监控

### 8.3 系统监控参数
- 内存使用情况
- WiFi信号强度（RSSI）
- 系统运行时间
- 报警队列大小
- 重试次数统计
- 睡眠/唤醒次数

## 9. 维护与故障排除

### 9.1 常见故障

| 故障现象 | 可能原因 | 解决方案 |
|----------|----------|----------|
| LED慢速闪烁 | WiFi连接失败 | 检查WiFi配置和网络状态 |
| LED快速闪烁 | 有报警待发送 | 检查网络连接和广播接收端 |
| LED双闪 | AP热点模式 | 检查WiFi网络可用性 |
| LED不亮 | 系统睡眠 | 正常状态，等待ADC触发唤醒 |
| 误报警 | ADC阈值过低 | 调整adcThreshold参数 |
| 无广播接收 | 端口或IP错误 | 检查广播端口和IP配置 |
| 频繁重启 | 电源不稳定 | 检查电源供应和连接 |

### 9.2 调试命令
```cpp
// 在串口监视器中可以看到的调试信息
"ADC值: 1250, 阈值: 1000, 状态: 触发"
"广播帧: AA 01 01 01 2D 55"
"WiFi状态: 已连接, RSSI: -45dBm"
"报警队列: 2/10, 待发送: 1"
"系统模式: 正常工作"
```

### 9.3 性能优化建议
1. **ADC阈值调整**: 根据实际传感器特性调整触发阈值
2. **网络优化**: 使用信号强度良好的WiFi网络
3. **电源管理**: 使用稳定的电源供应
4. **部署位置**: 避免电磁干扰环境
5. **定期维护**: 检查连接和清理历史数据

## 10. 高级功能

### 10.1 报警队列管理
- **FIFO队列**: 先进先出的报警处理顺序
- **持久化存储**: 使用Preferences库存储到Flash
- **自动恢复**: 断电重启后自动恢复未发送报警
- **队列清理**: 成功发送后自动清理记录

### 10.2 智能重试机制
- **指数退避**: 重试间隔逐渐增加
- **最大限制**: 重试间隔不超过60秒
- **次数统计**: 记录每个报警的重试次数
- **失败处理**: 超过最大重试次数的报警标记为失败

### 10.3 网络容错机制
- **双网络模式**: WiFi + AP热点备用
- **自动切换**: 主网络失败时自动切换备用网络
- **连接恢复**: 定期尝试恢复主网络连接
- **状态同步**: 不同网络模式下的状态同步

### 10.4 电源管理优化
- **动态睡眠**: 根据活动情况动态调整睡眠策略
- **唤醒优化**: 快速唤醒和状态恢复
- **功耗监控**: 实时监控系统功耗状态
- **电池支持**: 支持电池供电长期运行

## 11. 技术支持

### 11.1 开发环境
- Arduino IDE 2.0.x 或更高版本
- ESP32开发板支持包 v2.0.x
- XIAO ESP32-C6板级支持包

### 11.2 依赖库
- WiFi.h（ESP32内置）
- WiFiUdp.h（ESP32内置）
- Preferences.h（ESP32内置）
- esp_sleep.h（ESP32内置）
- esp_wifi.h（ESP32内置）

### 11.3 版本历史
- v1.0: 基础ADC检测功能
- v2.0: 增加UDP广播通信
- v3.0: 添加低功耗睡眠模式
- v3.1: 实现报警队列管理
- v3.2: 增加智能重试机制
- v3.3: 添加AP热点备用模式
- v3.4: 优化LED状态指示
- v3.5: 增强网络容错能力
- v3.6: 实现ADC自动恢复检测

## 12. 性能指标

### 12.1 响应性能
- ADC触发响应时间：<100ms
- 3.3V输出延迟：<50ms
- WiFi重连时间：5-20秒
- 广播发送成功率：>99%
- 睡眠唤醒时间：<200ms

### 12.2 功耗性能
- 正常工作模式：约150mA
- 低功耗模式：<10mA
- 睡眠模式功耗降低：>90%
- 24小时连续运行能力
- 电池模式续航：>48小时

### 12.3 可靠性指标
- 报警数据丢失率：<0.1%
- 网络异常恢复率：>95%
- 系统稳定运行时间：>30天
- 断电重启数据恢复：100%
- ADC检测精度：±1LSB

### 12.4 网络性能
- UDP广播延迟：<10ms
- 网络重连成功率：>98%
- AP热点切换时间：<30秒
- 广播覆盖范围：100米（开阔环境）
- 并发设备支持：>50个

## 13. 安全与合规

### 13.1 电气安全
- 使用标准5V/3.3V电源
- ADC输入保护：0-3.3V范围
- 输出短路保护
- 过压保护机制
- 良好的接地连接

### 13.2 网络安全
- WPA2/WPA3加密支持
- 自定义协议帧格式
- 设备ID唯一性验证
- 广播数据完整性检查
- 定期固件更新建议

### 13.3 使用限制
- 室内环境使用
- 工作温度范围：-40°C ~ +85°C
- 避免强电磁干扰
- 定期系统维护
- 遵循当地无线电管理规定

## 14. 部署指南

### 14.1 单设备部署
1. 配置WiFi连接参数
2. 设置唯一设备ID
3. 调整ADC阈值
4. 测试网络连通性
5. 部署到目标位置

### 14.2 多设备网络部署
1. 统一网络配置
2. 分配不同设备ID（1-254）
3. 配置中央接收服务器
4. 测试设备间通信
5. 建立监控系统

### 14.3 离线部署
1. 启用AP热点模式
2. 配置设备间通信
3. 设置数据中继节点
4. 建立本地监控网络
5. 定期数据同步

### 14.4 维护计划
- 每月检查系统状态
- 定期更新固件版本
- 清理历史报警数据
- 检查网络连接质量
- 备份重要配置参数

---

**文档版本**: v3.6  
**最后更新**: 2025年7月  
**技术支持**: 请联系系统开发团队  
**适用固件**: ADC检测广播系统 v3.6 (自动恢复版)  
**GitHub仓库**: [项目链接]  

